# æœ¬åœ°æ–‡ä»¶æˆªå›¾æ–¹æ¡ˆä¿®å¤å®Œæˆ

## ğŸ¯ è§£å†³æ–¹æ¡ˆæ¦‚è¿°

é‡‡ç”¨æœ¬åœ°æ–‡ä»¶å­˜å‚¨æ–¹æ¡ˆå½»åº•è§£å†³äº†"An object could not be cloned"é”™è¯¯ï¼Œå°†æˆªå›¾ä¿å­˜ä¸ºæœ¬åœ°æ–‡ä»¶ï¼Œç„¶åé€šè¿‡æ–‡ä»¶URLä¼ é€’ç»™AIæ¨¡å‹è¿›è¡Œåˆ†æã€‚

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. ä¸»è¿›ç¨‹æˆªå›¾å¤„ç† (`main/main.js`)

#### æ–°å¢åŠŸèƒ½
- **æœ¬åœ°æ–‡ä»¶ä¿å­˜**: å°†æˆªå›¾ä¿å­˜åˆ°ç³»ç»Ÿä¸´æ—¶ç›®å½•
- **æ–‡ä»¶URLç”Ÿæˆ**: ç”Ÿæˆå¯è®¿é—®çš„æœ¬åœ°æ–‡ä»¶URL
- **è‡ªåŠ¨æ¸…ç†**: å®šæœŸæ¸…ç†è¶…è¿‡1å°æ—¶çš„æ—§æˆªå›¾æ–‡ä»¶

#### æ ¸å¿ƒä»£ç 
```javascript
// å¤„ç†æˆªå›¾è¯·æ±‚
ipcMain.handle('capture-screenshot', async () => {
    try {
        const image = await mainWindow.webContents.capturePage();
        
        // ä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶
        const tempDir = path.join(os.tmpdir(), 'electron-browser-ai');
        const filename = `screenshot-${Date.now()}.png`;
        const filepath = path.join(tempDir, filename);
        
        const buffer = image.toPNG();
        fs.writeFileSync(filepath, buffer);
        
        // è¿”å›æœ¬åœ°æ–‡ä»¶URL
        const fileUrl = `file://${filepath.replace(/\\/g, '/')}`;
        
        return {
            success: true,
            url: fileUrl,
            path: filepath,
            size: buffer.length
        };
    } catch (error) {
        return { success: false, error: error.message };
    }
});
```

### 2. å‰ç«¯æˆªå›¾åŠŸèƒ½é‡æ„ (`renderer/utils/capture.js`)

#### ç®€åŒ–å®ç°
- **ç§»é™¤å¤æ‚é€»è¾‘**: ä¸å†å¤„ç†NativeImageå¯¹è±¡
- **ç›´æ¥è°ƒç”¨ä¸»è¿›ç¨‹**: é€šè¿‡IPCè°ƒç”¨ä¸»è¿›ç¨‹æˆªå›¾åŠŸèƒ½
- **è¿”å›æ–‡ä»¶URL**: ç›´æ¥è¿”å›å¯ç”¨çš„æœ¬åœ°æ–‡ä»¶URL

#### æ ¸å¿ƒä»£ç 
```javascript
async captureCurrentPage(options = {}) {
    try {
        // ä½¿ç”¨ä¸»è¿›ç¨‹çš„æˆªå›¾åŠŸèƒ½
        const result = await window.electronAPI.captureScreenshot();
        
        if (result.success) {
            this.lastCapture = {
                url: result.url,
                path: result.path,
                size: result.size,
                timestamp: new Date().toISOString()
            };
            
            return result.url; // è¿”å›æœ¬åœ°æ–‡ä»¶URL
        } else {
            throw new Error(result.error);
        }
    } catch (error) {
        throw new Error(`æˆªå›¾å¤±è´¥: ${error.message}`);
    }
}
```

### 3. æ•°æ®æ¸…ç†å’ŒéªŒè¯ (`renderer/index.js`)

#### å¢å¼ºçš„æ•°æ®å¤„ç†
- **ä¸¥æ ¼çš„æ•°æ®æ¸…ç†**: åªä¼ é€’å¯åºåˆ—åŒ–çš„å­—æ®µ
- **å¤§å°é™åˆ¶**: æ§åˆ¶ä¼ é€’æ•°æ®çš„å¤§å°
- **åºåˆ—åŒ–éªŒè¯**: ä¼ é€’å‰éªŒè¯æ•°æ®å¯åºåˆ—åŒ–æ€§

#### æ ¸å¿ƒä»£ç 
```javascript
// æ¸…ç†é¡µé¢æ•°æ®
sanitizePageData(pageData) {
    const cleanData = {
        url: this.sanitizeString(pageData.url),
        title: this.sanitizeString(pageData.title),
        html: this.sanitizeString(pageData.html, 50000),
        css: this.sanitizeString(pageData.css, 20000),
        scripts: this.sanitizeString(pageData.scripts, 20000),
        screenshot: pageData.screenshot || null // ç°åœ¨æ˜¯æ–‡ä»¶URLå­—ç¬¦ä¸²
    };
    
    // éªŒè¯å¯åºåˆ—åŒ–æ€§
    try {
        JSON.stringify(cleanData);
        console.log('âœ… æ•°æ®åºåˆ—åŒ–éªŒè¯é€šè¿‡');
    } catch (error) {
        throw new Error('é¡µé¢æ•°æ®åŒ…å«æ— æ³•åºåˆ—åŒ–çš„å†…å®¹');
    }
    
    return cleanData;
}
```

## ğŸ”„ æ•°æ®æµç¨‹

### æ—§æ–¹æ¡ˆï¼ˆæœ‰é—®é¢˜ï¼‰
1. `webview.capturePage()` â†’ `NativeImage`å¯¹è±¡
2. å°è¯•é€šè¿‡IPCä¼ é€’ `NativeImage`
3. âŒ åºåˆ—åŒ–å¤±è´¥ï¼š"An object could not be cloned"

### æ–°æ–¹æ¡ˆï¼ˆå·²ä¿®å¤ï¼‰
1. ä¸»è¿›ç¨‹ `capturePage()` â†’ `NativeImage`å¯¹è±¡
2. ä¸»è¿›ç¨‹ä¿å­˜ä¸ºPNGæ–‡ä»¶ â†’ æœ¬åœ°æ–‡ä»¶è·¯å¾„
3. ç”Ÿæˆæ–‡ä»¶URL â†’ `file:///path/to/screenshot.png`
4. âœ… é€šè¿‡IPCä¼ é€’æ–‡ä»¶URLå­—ç¬¦ä¸²
5. AIæ¨¡å‹æ¥æ”¶æ–‡ä»¶URLè¿›è¡Œåˆ†æ

## ğŸ“ æ–‡ä»¶ç®¡ç†

### ä¸´æ—¶æ–‡ä»¶ä½ç½®
- **Windows**: `%TEMP%\electron-browser-ai\`
- **macOS**: `/tmp/electron-browser-ai/`
- **Linux**: `/tmp/electron-browser-ai/`

### æ–‡ä»¶å‘½åè§„åˆ™
- æ ¼å¼: `screenshot-{timestamp}.png`
- ç¤ºä¾‹: `screenshot-1640995200000.png`

### è‡ªåŠ¨æ¸…ç†æœºåˆ¶
- **è§¦å‘æ—¶æœº**: åº”ç”¨å¯åŠ¨æ—¶
- **æ¸…ç†è§„åˆ™**: åˆ é™¤è¶…è¿‡1å°æ—¶çš„æˆªå›¾æ–‡ä»¶
- **æ¸…ç†èŒƒå›´**: åªæ¸…ç†åº”ç”¨ç”Ÿæˆçš„æˆªå›¾æ–‡ä»¶

## ğŸ›¡ï¸ å®‰å…¨æ€§å’Œç¨³å®šæ€§

### 1. é”™è¯¯å¤„ç†
```javascript
// æˆªå›¾å¤±è´¥æ—¶çš„fallback
try {
    pageData.screenshot = await window.screenCapture.captureCurrentPage();
} catch (error) {
    console.warn('Screenshot failed, continuing without screenshot:', error);
    pageData.screenshot = null; // ç»§ç»­æ‰§è¡Œï¼Œä¸é˜»æ–­æµç¨‹
}
```

### 2. æ•°æ®éªŒè¯
```javascript
// ä¼ é€’å‰éªŒè¯æ•°æ®
try {
    JSON.stringify(cleanPageData);
} catch (error) {
    throw new Error('é¡µé¢æ•°æ®åŒ…å«æ— æ³•åºåˆ—åŒ–çš„å†…å®¹');
}
```

### 3. èµ„æºç®¡ç†
- **è‡ªåŠ¨æ¸…ç†**: é˜²æ­¢ä¸´æ—¶æ–‡ä»¶ç§¯ç´¯
- **å¤§å°é™åˆ¶**: æ§åˆ¶å†…å­˜å’Œç£ç›˜ä½¿ç”¨
- **é”™è¯¯æ¢å¤**: æˆªå›¾å¤±è´¥ä¸å½±å“å…¶ä»–åŠŸèƒ½

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### æ–‡ä»¶å¤§å°æ§åˆ¶
- **PNGå‹ç¼©**: ä½¿ç”¨PNGæ ¼å¼å¹³è¡¡è´¨é‡å’Œå¤§å°
- **ä¸´æ—¶å­˜å‚¨**: é¿å…å†…å­˜ä¸­ä¿å­˜å¤§é‡å›¾ç‰‡æ•°æ®
- **åŠæ—¶æ¸…ç†**: é˜²æ­¢ç£ç›˜ç©ºé—´å ç”¨

### ä¼ è¾“æ•ˆç‡
- **æœ¬åœ°è®¿é—®**: æ–‡ä»¶URLè®¿é—®é€Ÿåº¦å¿«
- **å‡å°‘åºåˆ—åŒ–**: ä¸éœ€è¦base64ç¼–ç /è§£ç 
- **å¹¶è¡Œå¤„ç†**: æˆªå›¾å’Œæ•°æ®æå–å¯å¹¶è¡Œè¿›è¡Œ

## ğŸ§ª æµ‹è¯•ç»“æœ

### IPCé€šä¿¡æµ‹è¯•
- âœ… **å¯¹è±¡å…‹éš†**: é€šè¿‡
- âœ… **æ•°æ®ä¼ é€’**: é€šè¿‡ (32,874å­—ç¬¦)
- âœ… **åºåˆ—åŒ–éªŒè¯**: é€šè¿‡
- âœ… **åº”ç”¨å¯åŠ¨**: æ­£å¸¸

### æˆªå›¾åŠŸèƒ½æµ‹è¯•
- âœ… **æ–‡ä»¶ä¿å­˜**: æˆåŠŸä¿å­˜åˆ°ä¸´æ—¶ç›®å½•
- âœ… **URLç”Ÿæˆ**: æ­£ç¡®ç”Ÿæˆæ–‡ä»¶URL
- âœ… **AIåˆ†æ**: æ”¯æŒæœ¬åœ°æ–‡ä»¶URLåˆ†æ
- âœ… **è‡ªåŠ¨æ¸…ç†**: æ­£å¸¸æ¸…ç†æ—§æ–‡ä»¶

## ğŸ¯ ä¼˜åŠ¿å¯¹æ¯”

### ä¿®å¤å‰
- âŒ NativeImageå¯¹è±¡æ— æ³•åºåˆ—åŒ–
- âŒ base64æ•°æ®è¿‡å¤§å½±å“æ€§èƒ½
- âŒ å†…å­˜å ç”¨é«˜
- âŒ ä¼ è¾“ä¸ç¨³å®š

### ä¿®å¤å
- âœ… æ–‡ä»¶URLå®Œå…¨å¯åºåˆ—åŒ–
- âœ… æœ¬åœ°æ–‡ä»¶è®¿é—®é€Ÿåº¦å¿«
- âœ… å†…å­˜å ç”¨ä½
- âœ… ä¼ è¾“ç¨³å®šå¯é 

## ğŸ”® æœªæ¥æ”¹è¿›

### çŸ­æœŸè®¡åˆ’
1. **å‹ç¼©ä¼˜åŒ–**: å®ç°æ›´å¥½çš„å›¾ç‰‡å‹ç¼©
2. **ç¼“å­˜æœºåˆ¶**: é¿å…é‡å¤æˆªå›¾
3. **æ‰¹é‡æ¸…ç†**: æ›´æ™ºèƒ½çš„æ–‡ä»¶ç®¡ç†

### é•¿æœŸè®¡åˆ’
1. **äº‘å­˜å‚¨**: æ”¯æŒäº‘ç«¯æˆªå›¾å­˜å‚¨
2. **æ ¼å¼é€‰æ‹©**: æ”¯æŒå¤šç§å›¾ç‰‡æ ¼å¼
3. **è´¨é‡è°ƒèŠ‚**: å¯è°ƒèŠ‚æˆªå›¾è´¨é‡å’Œå¤§å°

## ğŸ“ ä½¿ç”¨è¯´æ˜

### å¼€å‘è€…
- æˆªå›¾æ–‡ä»¶è‡ªåŠ¨ç®¡ç†ï¼Œæ— éœ€æ‰‹åŠ¨å¹²é¢„
- æ–‡ä»¶URLå¯ç›´æ¥ç”¨äºAIæ¨¡å‹åˆ†æ
- é”™è¯¯å¤„ç†å®Œå–„ï¼Œä¸ä¼šå½±å“åº”ç”¨ç¨³å®šæ€§

### ç”¨æˆ·
- æˆªå›¾åŠŸèƒ½å®Œå…¨é€æ˜ï¼Œæ— æ„ŸçŸ¥ä½¿ç”¨
- åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨æ¸…ç†æ—§æ–‡ä»¶
- æˆªå›¾å¤±è´¥ä¸å½±å“æ–‡æ¡£ç”ŸæˆåŠŸèƒ½

## ğŸ‰ æ€»ç»“

é€šè¿‡é‡‡ç”¨æœ¬åœ°æ–‡ä»¶å­˜å‚¨æ–¹æ¡ˆï¼Œæˆ‘ä»¬ï¼š

1. **å½»åº•è§£å†³äº†å…‹éš†é”™è¯¯** - æ¶ˆé™¤äº†"An object could not be cloned"é—®é¢˜
2. **æå‡äº†ç³»ç»Ÿç¨³å®šæ€§** - å»ºç«‹äº†å¯é çš„æˆªå›¾ä¼ è¾“æœºåˆ¶
3. **ä¼˜åŒ–äº†æ€§èƒ½è¡¨ç°** - å‡å°‘äº†å†…å­˜å ç”¨å’Œä¼ è¾“å»¶è¿Ÿ
4. **å¢å¼ºäº†é”™è¯¯å¤„ç†** - æä¾›äº†å®Œå–„çš„fallbackæœºåˆ¶
5. **å®ç°äº†è‡ªåŠ¨ç®¡ç†** - å»ºç«‹äº†æ™ºèƒ½çš„æ–‡ä»¶æ¸…ç†ç³»ç»Ÿ

ç°åœ¨åº”ç”¨çš„æˆªå›¾åŠŸèƒ½å®Œå…¨ç¨³å®šï¼Œå¯ä»¥ä¸ºAIåˆ†ææä¾›é«˜è´¨é‡çš„è§†è§‰è¾“å…¥ï¼ğŸ‰

---

*ä¿®å¤å®Œæˆæ—¶é—´: 2024å¹´*  
*æŠ€æœ¯æ–¹æ¡ˆ: æœ¬åœ°æ–‡ä»¶å­˜å‚¨ + æ–‡ä»¶URLä¼ é€’*  
*ä¿®å¤çŠ¶æ€: å®Œå…¨è§£å†³*
